<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ Real-Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        /* Animation Pulse for Status */
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .status-pulse { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 pb-24"> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° padding bottom ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Status Bar -->

    <script>
        // ==========================================
        //  ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbweuotqV6OkcZDlB67l6zchQEmjTRPRhHYxZ2V6S0FwZKmySHeDHMG5ZQ6_PoUHG2pWYg/exec"; 
    </script>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex flex-col justify-center items-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-white mb-3"></div>
        <p class="text-white font-medium" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- HEADER -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600 cursor-pointer" onclick="toggleView('user')">FOOD APP</div>
            <div class="flex items-center gap-3">
                <button onclick="accessAdmin()" class="text-gray-500 hover:text-blue-600"><i data-feather="monitor"></i></button>
                <button onclick="toggleCartModal(true)" class="relative p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                    <i data-feather="shopping-cart" class="w-5 h-5 text-gray-700"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- VIEW: USER -->
    <div id="view-user" class="container mx-auto p-4 transition-opacity duration-300">
        <!-- Category Filter -->
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scroll pb-2">
            <button onclick="filterCategory('all')" class="cat-btn active flex-shrink-0 px-6 py-2 rounded-full bg-blue-600 text-white shadow-md transition" data-cat="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="filterCategory('food')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="food">üç≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
            <button onclick="filterCategory('drink')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="drink">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
            <button onclick="filterCategory('dessert')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="dessert">üç∞ ‡∏Ç‡∏ô‡∏°</button>
        </div>

        <!-- Product Grid -->
        <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>

    <!-- REAL-TIME STATUS BAR (Fixed Bottom) -->
    <div id="status-bar" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 p-4 hidden transform translate-y-full transition-transform duration-300 border-t border-gray-200">
        <div class="container mx-auto max-w-2xl flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div id="status-icon" class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 status-pulse">
                    <i data-feather="clock"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <span id="status-order-id">...</span></p>
                    <p class="font-bold text-lg" id="status-text">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                </div>
            </div>
            <button onclick="clearCurrentOrder()" class="text-xs text-gray-400 underline hover:text-red-500">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- VIEW: ADMIN -->
    <div id="view-admin" class="container mx-auto p-4 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
            <button onclick="fetchOrders()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 flex items-center gap-2">
                <i data-feather="refresh-cw" class="w-4 h-4"></i>
            </button>
        </div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</th>
                            <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="admin-order-list" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-end hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl transform translate-x-full transition-transform duration-300" id="cart-panel">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button onclick="toggleCartModal(false)" class="text-gray-500"><i data-feather="x"></i></button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            <div class="p-5 border-t bg-gray-50">
                <div class="flex justify-between text-lg font-bold mb-4"><span>‡∏£‡∏ß‡∏°</span><span id="cart-total" class="text-blue-600">‡∏ø0</span></div>
                <div class="space-y-3 mb-4">
                    <input type="text" id="cust-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full border p-2 rounded">
                    <input type="text" id="table-no" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞" class="w-full border p-2 rounded">
                </div>
                <button onclick="submitOrder()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
        </div>
    </div>

    <script>
        // === GLOBAL STATE ===
        let products = [];
        let cart = [];
        let currentCat = 'all';
        let pollingInterval = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

        feather.replace();

        // Start
        window.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            checkExistingOrder(); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        });

        // =========================================
        //  REAL-TIME LOGIC (POLLING)
        // =========================================

        function checkExistingOrder() {
            // ‡∏î‡∏π‡πÉ‡∏ô LocalStorage ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏´‡∏°
            const lastOrder = localStorage.getItem('lastOrderId');
            if(lastOrder) {
                showStatusBar(lastOrder);
                startPolling(lastOrder);
            }
        }

        function startPolling(orderId) {
            if(pollingInterval) clearInterval(pollingInterval);
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            updateStatusUI(orderId);

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (Polling)
            pollingInterval = setInterval(() => {
                updateStatusUI(orderId);
            }, 5000); 
        }

        async function updateStatusUI(orderId) {
            try {
                const res = await fetch(`${API_URL}?action=checkStatus&orderId=${orderId}`);
                const data = await res.json();
                
                const statusText = document.getElementById('status-text');
                const statusIcon = document.getElementById('status-icon');
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                if(data.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                    statusText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...";
                    statusIcon.className = "w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 status-pulse";
                    statusIcon.innerHTML = `<i data-feather="clock"></i>`;
                } else if (data.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') {
                    statusText.innerText = "üë®‚Äçüç≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£...";
                    statusText.className = "font-bold text-lg text-blue-600";
                    statusIcon.className = "w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 status-pulse";
                    statusIcon.innerHTML = `<i data-feather="loader"></i>`;
                } else if (data.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
                    statusText.innerText = "‚úÖ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß/‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß";
                    statusText.className = "font-bold text-lg text-green-600";
                    statusIcon.className = "w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600";
                    statusIcon.innerHTML = `<i data-feather="check"></i>`;
                    
                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
                    setTimeout(() => clearInterval(pollingInterval), 30000);
                }
                feather.replace();
            } catch (err) {
                console.error("Polling error:", err);
            }
        }

        function showStatusBar(orderId) {
            const bar = document.getElementById('status-bar');
            document.getElementById('status-order-id').innerText = orderId;
            bar.classList.remove('hidden');
            setTimeout(() => bar.classList.remove('translate-y-full'), 100);
        }

        function clearCurrentOrder() {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ
            localStorage.removeItem('lastOrderId');
            clearInterval(pollingInterval);
            const bar = document.getElementById('status-bar');
            bar.classList.add('translate-y-full');
            setTimeout(() => bar.classList.add('hidden'), 300);
        }


        // =========================================
        //  CORE APP LOGIC
        // =========================================

        async function fetchProducts() {
            toggleLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getProducts`);
                products = await res.json();
                renderProducts();
            } catch (err) { alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); } 
            finally { toggleLoading(false); }
        }

        function renderProducts() {
            const container = document.getElementById('product-list');
            const filtered = currentCat === 'all' ? products : products.filter(p => p.category === currentCat);
            container.innerHTML = filtered.map(p => {
                const inCart = cart.find(c => c.id === p.id);
                const qty = inCart ? inCart.quantity : 0;
                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                    <div class="relative h-40">
                        <img src="${p.img}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300?text=No+Image'">
                        ${qty > 0 ? `<div class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">${qty}</div>` : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <h3 class="font-bold text-gray-800 line-clamp-1">${p.name}</h3>
                        <p class="text-blue-600 font-bold mb-3">‡∏ø${p.price}</p>
                        <button onclick="addToCart(${p.id})" class="mt-auto w-full bg-gray-50 text-blue-600 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 hover:text-white transition">‡πÄ‡∏û‡∏¥‡πà‡∏° +</button>
                    </div>
                </div>`;
            }).join('');
        }

        function filterCategory(cat) {
            currentCat = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                const isActive = btn.dataset.cat === cat;
                btn.className = `cat-btn flex-shrink-0 px-6 py-2 rounded-full transition ${isActive ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'}`;
            });
            renderProducts();
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.quantity++; else cart.push({...p, quantity: 1});
            updateCartUI(); renderProducts();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);
            document.getElementById('cart-badge').innerText = totalItems;
            document.getElementById('cart-badge').classList.toggle('hidden', totalItems === 0);
            
            const container = document.getElementById('cart-items');
            container.innerHTML = cart.map((item, idx) => `
                <div class="flex gap-4 items-center">
                    <img src="${item.img}" class="w-12 h-12 rounded bg-gray-200 object-cover">
                    <div class="flex-1">
                        <div class="font-bold text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">‡∏ø${item.price} x ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQty(${idx}, -1)" class="w-6 h-6 bg-gray-200 rounded">-</button>
                        <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                        <button onclick="changeQty(${idx}, 1)" class="w-6 h-6 bg-gray-200 rounded">+</button>
                    </div>
                </div>`).join('');
            
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('cart-total').innerText = `‡∏ø${total}`;
        }

        function changeQty(idx, delta) {
            cart[idx].quantity += delta;
            if(cart[idx].quantity <= 0) cart.splice(idx, 1);
            updateCartUI(); renderProducts();
        }

        async function submitOrder() {
            const name = document.getElementById('cust-name').value;
            const table = document.getElementById('table-no').value;
            if(!cart.length || !name || !table) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...");
            const orderId = `ORD-${Date.now().toString().slice(-5)}`;
            const payload = {
                action: "createOrder",
                orderNumber: orderId,
                tableName: table,
                buyerName: name,
                items: cart,
                total: cart.reduce((sum, i) => sum + (i.price * i.quantity), 0)
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                localStorage.setItem('lastOrderId', orderId);
                
                // Reset Cart
                cart = []; updateCartUI(); renderProducts();
                toggleCartModal(false);
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
                showStatusBar(orderId);
                startPolling(orderId);
                
                alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞");
            } catch (err) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
            finally { toggleLoading(false); }
        }

        // =========================================
        //  ADMIN LOGIC
        // =========================================

        function accessAdmin() {
            if(prompt("Admin Password:") === "Admin1234") {
                toggleView('admin'); fetchOrders();
            }
        }

        async function fetchOrders() {
            toggleLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getOrders`);
                const orders = await res.json();
                renderAdminOrders(orders);
            } catch(e) { console.log(e); } 
            finally { toggleLoading(false); }
        }

        function renderAdminOrders(orders) {
            const tbody = document.getElementById('admin-order-list');
            if(!orders.length) return tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
            
            tbody.innerHTML = orders.map(o => {
                // Determine Colors
                let statusColor = "bg-gray-100 text-gray-600";
                if(o.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') statusColor = "bg-blue-100 text-blue-700";
                if(o.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') statusColor = "bg-green-100 text-green-700";

                return `
                <tr class="hover:bg-gray-50 border-b transition">
                    <td class="p-4">
                        <div class="font-bold">${o.tableName}</div>
                        <div class="text-xs text-gray-500">${o.time.split(' ')[1] || o.time}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-medium text-sm">${o.buyerName}</div>
                        <div class="text-xs text-gray-500 mt-1">${o.items}</div>
                    </td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${o.status}</span></td>
                    <td class="p-4">
                        <div class="flex gap-2 justify-center">
                            ${o.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 
                                `<button onclick="setStatus('${o.orderNumber}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á')" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded text-xs flex items-center gap-1 shadow">
                                    <i data-feather="play-circle" class="w-4 h-4"></i> ‡∏õ‡∏£‡∏∏‡∏á
                                </button>` : ''}
                            
                            ${o.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 
                                `<button onclick="setStatus('${o.orderNumber}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded text-xs flex items-center gap-1 shadow">
                                    <i data-feather="check-circle" class="w-4 h-4"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à
                                </button>` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');
            feather.replace();
        }

        async function setStatus(id, status) {
            if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${status}"?`)) return;
            toggleLoading(true);
            try {
                await fetch(API_URL, {
                    method: 'POST', 
                    body: JSON.stringify({ action: 'updateStatus', orderNumber: id, newStatus: status })
                });
                fetchOrders();
            } catch(e) { alert("Error"); }
            finally { toggleLoading(false); }
        }

        // Utils
        function toggleView(view) {
            document.getElementById('view-user').classList.toggle('hidden', view !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
            if(view === 'user') feather.replace();
        }
        function toggleCartModal(show) {
            const el = document.getElementById('cart-modal');
            const pn = document.getElementById('cart-panel');
            if(show) { el.classList.remove('hidden'); setTimeout(()=> { el.classList.remove('opacity-0'); pn.classList.remove('translate-x-full'); }, 10); }
            else { el.classList.add('opacity-0'); pn.classList.add('translate-x-full'); setTimeout(()=> el.classList.add('hidden'), 300); }
        }
        function toggleLoading(show, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
            const el = document.getElementById('loading-overlay');
            document.getElementById('loading-text').innerText = text;
            el.classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
