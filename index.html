<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö POS ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .status-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Date Picker ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
            color: #374151;
            font-family: 'Sarabun', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 pb-24">

    <!-- CONFIG -->
    <script>
        // ==========================================
        //  ‡πÉ‡∏™‡πà URL Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const API_URL = "‡∏ß‡∏≤‡∏á_WEB_APP_URL_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"; 
    </script>

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex flex-col justify-center items-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-white mb-3"></div>
        <p class="text-white font-medium" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- HEADER -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600 cursor-pointer" onclick="switchPage('user')">FOOD APP</div>
            <div class="flex items-center gap-3">
                <button onclick="accessAdmin()" class="text-gray-500 hover:text-blue-600 font-medium text-sm flex items-center gap-1">
                    <i data-feather="settings" class="w-4 h-4"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô
                </button>
                <button onclick="toggleCartModal(true)" class="relative p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                    <i data-feather="shopping-cart" class="w-5 h-5 text-gray-700"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- ================= VIEW: USER ================= -->
    <div id="view-user" class="container mx-auto p-4 transition-opacity duration-300">
        <!-- Category -->
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scroll pb-2">
            <button onclick="filterCategory('all')" class="cat-btn active flex-shrink-0 px-6 py-2 rounded-full bg-blue-600 text-white shadow-md transition" data-cat="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="filterCategory('food')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="food">üç≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
            <button onclick="filterCategory('drink')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="drink">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
            <button onclick="filterCategory('dessert')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="dessert">üç∞ ‡∏Ç‡∏ô‡∏°</button>
        </div>
        <!-- Products -->
        <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>

    <!-- STATUS BAR (USER) -->
    <div id="status-bar" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 p-4 hidden transform translate-y-full transition-transform duration-300 border-t border-gray-200">
        <div class="container mx-auto max-w-2xl flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div id="status-icon" class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 status-pulse"><i data-feather="clock"></i></div>
                <div>
                    <p class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <span id="status-order-id">...</span></p>
                    <p class="font-bold text-lg" id="status-text">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                </div>
            </div>
            <button onclick="clearCurrentOrder()" class="text-xs text-gray-400 underline hover:text-red-500">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- ================= VIEW: ADMIN ================= -->
    <div id="view-admin" class="container mx-auto p-4 hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
            
            <!-- Admin Tabs -->
            <div class="flex bg-gray-200 p-1 rounded-lg">
                <button onclick="switchAdminTab('kitchen')" id="tab-kitchen" class="px-4 py-2 rounded-md font-medium text-sm bg-white shadow-sm text-gray-800 transition">‡∏Ñ‡∏£‡∏±‡∏ß (Orders)</button>
                <button onclick="switchAdminTab('sales')" id="tab-sales" class="px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:text-gray-800 transition">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Sales)</button>
            </div>
            
            <button onclick="refreshAdminData()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 flex items-center gap-2 text-sm font-bold">
                <i data-feather="refresh-cw" class="w-4 h-4"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- TAB: KITCHEN -->
        <div id="admin-kitchen" class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-4 bg-orange-50 border-b border-orange-100 font-bold text-orange-800 flex items-center gap-2">
                <i data-feather="bell" class="w-4 h-4"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</th>
                            <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="kitchen-list" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB: SALES REPORT (UPDATED) -->
        <div id="admin-sales" class="hidden space-y-6">
            <!-- Filter & Summary -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Date Filter -->
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col justify-center">
                    <label class="text-sm text-gray-500 mb-1 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</label>
                    <div class="flex gap-2">
                        <input type="date" id="sales-date-picker" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none text-gray-700" onchange="filterSalesByDate()">
                        <button onclick="resetDateFilter()" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200 text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                    </div>
                </div>

                <!-- Total Revenue -->
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 flex justify-between items-center">
                    <div>
                        <h3 class="text-gray-500 font-medium text-sm">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
                        <p class="text-3xl font-bold text-green-600 mt-1" id="sales-total-revenue">‡∏ø0.00</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                        <i data-feather="dollar-sign"></i>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-4 bg-blue-50 border-b border-blue-100 font-bold text-blue-800 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i data-feather="file-text" class="w-4 h-4"></i> 
                        <span id="sales-table-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                    </div>
                    <span class="text-xs font-normal bg-white px-2 py-1 rounded border text-blue-600" id="sales-count-badge">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</th>
                                <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞</th>
                                <th class="p-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="sales-list" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-end hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl transform translate-x-full transition-transform duration-300" id="cart-panel">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button onclick="toggleCartModal(false)" class="text-gray-500"><i data-feather="x"></i></button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            <div class="p-5 border-t bg-gray-50">
                <div class="flex justify-between text-lg font-bold mb-4"><span>‡∏£‡∏ß‡∏°</span><span id="cart-total" class="text-blue-600">‡∏ø0</span></div>
                <div class="space-y-3 mb-4">
                    <input type="text" id="cust-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full border p-2 rounded">
                    <input type="text" id="table-no" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞" class="w-full border p-2 rounded">
                </div>
                <button onclick="submitOrder()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button onclick="closePaymentModal()" class="text-white hover:text-gray-200"><i data-feather="x"></i></button>
            </div>
            <div class="p-6">
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-sm">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                    <p class="text-4xl font-bold text-blue-600" id="pay-total-display">‡∏ø0.00</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="pay-received" class="w-full p-3 border rounded-lg text-xl text-center focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00" oninput="calculateChange()">
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span>
                        <span class="font-bold text-xl text-green-600" id="pay-change">‡∏ø0.00</span>
                    </div>
                </div>
                <button onclick="confirmPayment()" class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-lg flex justify-center items-center gap-2">
                    <i data-feather="check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // === STATE ===
        let products = [], cart = [], currentCat = 'all';
        let pollingInterval = null;
        let activeAdminTab = 'kitchen';
        let currentPaymentOrder = null;
        let allSalesData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤

        // === INIT ===
        window.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            checkExistingOrder();
            feather.replace();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Date Picker ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            document.getElementById('sales-date-picker').valueAsDate = new Date();
        });

        // === USER FUNCTIONALITY ===
        async function fetchProducts() {
            toggleLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getProducts`);
                products = await res.json();
                renderProducts();
            } catch (err) { alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); } 
            finally { toggleLoading(false); }
        }

        function renderProducts() {
            const container = document.getElementById('product-list');
            const filtered = currentCat === 'all' ? products : products.filter(p => p.category === currentCat);
            container.innerHTML = filtered.map(p => {
                const inCart = cart.find(c => c.id === p.id);
                const qty = inCart ? inCart.quantity : 0;
                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                    <div class="relative h-40">
                        <img src="${p.img}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300?text=No+Image'">
                        ${qty > 0 ? `<div class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">${qty}</div>` : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <h3 class="font-bold text-gray-800 line-clamp-1">${p.name}</h3>
                        <p class="text-blue-600 font-bold mb-3">‡∏ø${p.price}</p>
                        <button onclick="addToCart(${p.id})" class="mt-auto w-full bg-gray-50 text-blue-600 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 transition">‡πÄ‡∏û‡∏¥‡πà‡∏° +</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function filterCategory(cat) {
            currentCat = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.className = `cat-btn flex-shrink-0 px-6 py-2 rounded-full transition ${btn.dataset.cat===cat ? 'bg-blue-600 text-white shadow-md':'bg-white text-gray-600 border border-gray-200'}`);
            renderProducts();
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.quantity++; else cart.push({...p, quantity: 1});
            updateCartUI(); renderProducts();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = totalItems;
            badge.classList.toggle('hidden', totalItems === 0);
            const container = document.getElementById('cart-items');
            container.innerHTML = cart.map((item, idx) => `
                <div class="flex gap-4 items-center">
                    <img src="${item.img}" class="w-12 h-12 rounded bg-gray-200 object-cover">
                    <div class="flex-1">
                        <div class="font-bold text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">‡∏ø${item.price} x ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQty(${idx}, -1)" class="w-6 h-6 bg-gray-200 rounded">-</button>
                        <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                        <button onclick="changeQty(${idx}, 1)" class="w-6 h-6 bg-gray-200 rounded">+</button>
                    </div>
                </div>`).join('');
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('cart-total').innerText = `‡∏ø${total}`;
        }

        function changeQty(idx, delta) {
            cart[idx].quantity += delta;
            if(cart[idx].quantity <= 0) cart.splice(idx, 1);
            updateCartUI(); renderProducts();
        }

        async function submitOrder() {
            const name = document.getElementById('cust-name').value;
            const table = document.getElementById('table-no').value;
            if(!cart.length || !name || !table) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...");
            const orderId = `ORD-${Date.now().toString().slice(-5)}`;
            const payload = {
                action: "createOrder",
                orderNumber: orderId,
                tableName: table,
                buyerName: name,
                items: cart,
                total: cart.reduce((sum, i) => sum + (i.price * i.quantity), 0)
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                localStorage.setItem('lastOrderId', orderId);
                cart = []; updateCartUI(); renderProducts(); toggleCartModal(false);
                showStatusBar(orderId); startPolling(orderId);
                alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (err) { alert("Error"); }
            finally { toggleLoading(false); }
        }

        // === POLLING STATUS ===
        function checkExistingOrder() {
            const lastOrder = localStorage.getItem('lastOrderId');
            if(lastOrder) { showStatusBar(lastOrder); startPolling(lastOrder); }
        }
        function startPolling(id) {
            if(pollingInterval) clearInterval(pollingInterval);
            updateStatusUI(id);
            pollingInterval = setInterval(() => updateStatusUI(id), 5000);
        }
        async function updateStatusUI(id) {
            try {
                const res = await fetch(`${API_URL}?action=checkStatus&orderId=${id}`);
                const data = await res.json();
                const txt = document.getElementById('status-text');
                const ico = document.getElementById('status-icon');
                if(data.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') { txt.innerText="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"; ico.className="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 status-pulse"; }
                else if(data.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') { txt.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£"; txt.className="font-bold text-lg text-blue-600"; ico.className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 status-pulse"; ico.innerHTML=`<i data-feather="loader"></i>`; }
                else if(data.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') { txt.innerText="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"; txt.className="font-bold text-lg text-green-600"; ico.className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"; ico.innerHTML=`<i data-feather="check"></i>`; setTimeout(()=>clearInterval(pollingInterval),30000); }
                feather.replace();
            } catch(e){}
        }
        function showStatusBar(id) {
            const bar = document.getElementById('status-bar');
            document.getElementById('status-order-id').innerText = id;
            bar.classList.remove('hidden'); setTimeout(()=>bar.classList.remove('translate-y-full'),100);
        }
        function clearCurrentOrder() {
            localStorage.removeItem('lastOrderId'); clearInterval(pollingInterval);
            const bar = document.getElementById('status-bar');
            bar.classList.add('translate-y-full'); setTimeout(()=>bar.classList.add('hidden'),300);
        }

        // ===============================================
        //  ADMIN SYSTEM
        // ===============================================

        function accessAdmin() {
            if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin:") === "1234") {
                switchPage('admin');
                refreshAdminData();
            }
        }

        function switchPage(page) {
            document.getElementById('view-user').classList.toggle('hidden', page!=='user');
            document.getElementById('view-admin').classList.toggle('hidden', page!=='admin');
            if(page==='user') feather.replace();
        }

        function switchAdminTab(tab) {
            activeAdminTab = tab;
            const btnKitchen = document.getElementById('tab-kitchen');
            const btnSales = document.getElementById('tab-sales');
            const divKitchen = document.getElementById('admin-kitchen');
            const divSales = document.getElementById('admin-sales');

            if(tab === 'kitchen') {
                btnKitchen.className = "px-4 py-2 rounded-md font-medium text-sm bg-white shadow-sm text-gray-800 transition";
                btnSales.className = "px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:text-gray-800 transition";
                divKitchen.classList.remove('hidden');
                divSales.classList.add('hidden');
            } else {
                btnKitchen.className = "px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:text-gray-800 transition";
                btnSales.className = "px-4 py-2 rounded-md font-medium text-sm bg-white shadow-sm text-gray-800 transition";
                divKitchen.classList.add('hidden');
                divSales.classList.remove('hidden');
            }
            refreshAdminData();
        }

        async function refreshAdminData() {
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            try {
                if(activeAdminTab === 'kitchen') {
                    const res = await fetch(`${API_URL}?action=getOrders`);
                    const orders = await res.json();
                    renderKitchenList(orders);
                } else {
                    const res = await fetch(`${API_URL}?action=getSalesReport`);
                    allSalesData = await res.json(); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                    filterSalesByDate(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                }
            } catch(e) { console.error(e); } 
            finally { toggleLoading(false); }
        }

        // --- Render Kitchen ---
        function renderKitchenList(orders) {
            const tbody = document.getElementById('kitchen-list');
            if(!orders.length) return tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</td></tr>`;
            tbody.innerHTML = orders.map(o => {
                let statusColor = "bg-gray-100 text-gray-600";
                if(o.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') statusColor = "bg-blue-100 text-blue-700";
                if(o.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') statusColor = "bg-green-100 text-green-700";
                
                let buttons = '';
                if(o.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                    buttons = `<button onclick="setKitchenStatus('${o.orderNumber}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á')" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded text-xs flex items-center gap-1 shadow"><i data-feather="play-circle" class="w-4 h-4"></i> ‡∏õ‡∏£‡∏∏‡∏á</button>`;
                } else if(o.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') {
                    buttons = `<button onclick="setKitchenStatus('${o.orderNumber}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded text-xs flex items-center gap-1 shadow"><i data-feather="check-circle" class="w-4 h-4"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à</button>`;
                }

                return `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4"><div class="font-bold">${o.tableName}</div><div class="text-xs text-gray-500">${o.time.split(' ')[1]||o.time}</div></td>
                    <td class="p-4"><div class="font-medium text-sm">${o.buyerName}</div><div class="text-xs text-gray-500 mt-1">${o.items}</div></td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${o.status}</span></td>
                    <td class="p-4 flex justify-center gap-2">${buttons}</td>
                </tr>`;
            }).join('');
            feather.replace();
        }

        async function setKitchenStatus(id, status) {
            if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${status}"?`)) return;
            toggleLoading(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', orderNumber: id, newStatus: status }) });
                refreshAdminData();
            } catch(e) { alert("Error"); }
            finally { toggleLoading(false); }
        }

        // --- SALES & FILTERING LOGIC (NEW) ---
        function resetDateFilter() {
            document.getElementById('sales-date-picker').valueAsDate = new Date();
            filterSalesByDate();
        }

        function filterSalesByDate() {
            const inputDate = document.getElementById('sales-date-picker').value; // yyyy-mm-dd
            if(!inputDate) return;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà input ‡πÄ‡∏õ‡πá‡∏ô array [YYYY, MM, DD]
            const [selY, selM, selD] = inputDate.split('-').map(Number);

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const filteredSales = allSalesData.filter(item => {
                // item.time ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "17/12/2568 18:30:00"
                // ‡πÅ‡∏¢‡∏Å String
                const [datePart, timePart] = item.time.split(' ');
                const [d, m, yThai] = datePart.split('/').map(Number);
                
                // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (2568 - 543 = 2025)
                const yEng = yThai > 2400 ? yThai - 543 : yThai;

                // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                return d === selD && m === selM && yEng === selY;
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
            const tableTitle = document.getElementById('sales-table-title');
            const formattedDate = new Date(selY, selM-1, selD).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
            tableTitle.innerText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ${formattedDate}`;

            renderSalesList(filteredSales);
        }

        function renderSalesList(sales) {
            const tbody = document.getElementById('sales-list');
            const badge = document.getElementById('sales-count-badge');
            
            // Calculate Total Revenue
            const totalRevenue = sales.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('sales-total-revenue').innerText = `‡∏ø${totalRevenue.toLocaleString()}`;
            badge.innerText = `${sales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if(!sales.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400 border-b">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
                return;
            }

            tbody.innerHTML = sales.map(s => {
                const isPaid = s.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                const statusBadge = isPaid 
                    ? `<span class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>`
                    : `<span class="px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</span>`;
                
                const actionBtn = isPaid
                    ? `<span class="text-gray-400 text-xs flex justify-center items-center gap-1"><i data-feather="check" class="w-3 h-3"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>`
                    : `<button onclick='openPaymentModal(${JSON.stringify(s)})' class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs shadow">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>`;

                return `
                <tr class="hover:bg-gray-50 border-b last:border-0">
                    <td class="p-4"><div class="text-xs text-gray-500">${s.time.split(' ')[1]}</div><div class="font-bold text-gray-800">${s.tableName}</div></td>
                    <td class="p-4"><div class="text-sm font-medium text-gray-800">${s.buyerName}</div><div class="text-xs text-gray-500 truncate w-40 mt-0.5">${s.items}</div></td>
                    <td class="p-4 text-right font-bold text-gray-700">‡∏ø${s.total}</td>
                    <td class="p-4 text-center">${statusBadge}</td>
                    <td class="p-4 text-center">${actionBtn}</td>
                </tr>`;
            }).join('');
            feather.replace();
        }

        // --- Payment Logic ---
        function openPaymentModal(order) {
            currentPaymentOrder = order;
            document.getElementById('pay-total-display').innerText = `‡∏ø${order.total}`;
            document.getElementById('pay-received').value = '';
            document.getElementById('pay-change').innerText = '‡∏ø0.00';
            document.getElementById('payment-modal').classList.remove('hidden');
            document.getElementById('pay-received').focus();
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            currentPaymentOrder = null;
        }

        function calculateChange() {
            if(!currentPaymentOrder) return;
            const received = parseFloat(document.getElementById('pay-received').value) || 0;
            const change = received - currentPaymentOrder.total;
            const changeEl = document.getElementById('pay-change');
            if(change >= 0) {
                changeEl.innerText = `‡∏ø${change.toFixed(2)}`;
                changeEl.className = "font-bold text-xl text-green-600";
            } else {
                changeEl.innerText = `‡∏Ç‡∏≤‡∏î ‡∏ø${Math.abs(change).toFixed(2)}`;
                changeEl.className = "font-bold text-xl text-red-600";
            }
        }

        async function confirmPayment() {
            if(!currentPaymentOrder) return;
            const received = parseFloat(document.getElementById('pay-received').value) || 0;
            if(received < currentPaymentOrder.total) {
                alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
                return;
            }

            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞?")) return;

            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'updatePayment', 
                        orderNumber: currentPaymentOrder.orderNumber 
                    }) 
                });
                closePaymentModal();
                refreshAdminData(); // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡∏∞ filter ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
            finally { toggleLoading(false); }
        }

        // Utils
        function toggleCartModal(show) {
            const el=document.getElementById('cart-modal'), pn=document.getElementById('cart-panel');
            if(show){el.classList.remove('hidden');setTimeout(()=>{el.classList.remove('opacity-0');pn.classList.remove('translate-x-full')},10)}
            else{el.classList.add('opacity-0');pn.classList.add('translate-x-full');setTimeout(()=>el.classList.add('hidden'),300)}
        }
        function toggleLoading(show, txt="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."){
            document.getElementById('loading-overlay').classList.toggle('hidden',!show);
            document.getElementById('loading-text').innerText=txt;
        }
    </script>
</body>
</html>
