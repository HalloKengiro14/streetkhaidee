<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö POS ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .status-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-gray-50 pb-24">

    <!-- CONFIG -->
    <script>
        // ==========================================
        //  ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbweuotqV6OkcZDlB67l6zchQEmjTRPRhHYxZ2V6S0FwZKmySHeDHMG5ZQ6_PoUHG2pWYg/exec"; 
    </script>

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex flex-col justify-center items-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-white mb-3"></div>
        <p class="text-white font-medium" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- HEADER -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600 cursor-pointer" onclick="switchPage('user')">FOOD APP</div>
            <div class="flex items-center gap-3">
                <button onclick="accessAdmin()" class="text-gray-500 hover:text-blue-600 font-medium text-sm flex items-center gap-1">
                    <i data-feather="settings" class="w-4 h-4"></i> ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
                </button>
                <button onclick="toggleCartModal(true)" class="relative p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                    <i data-feather="shopping-cart" class="w-5 h-5 text-gray-700"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- ================= VIEW: USER (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ================= -->
    <div id="view-user" class="container mx-auto p-4 transition-opacity duration-300">
        <!-- Category -->
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scroll pb-2">
            <button onclick="filterCategory('all')" class="cat-btn active flex-shrink-0 px-6 py-2 rounded-full bg-blue-600 text-white shadow-md transition" data-cat="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="filterCategory('food')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="food">üç≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
            <button onclick="filterCategory('drink')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="drink">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
            <button onclick="filterCategory('dessert')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition" data-cat="dessert">üç∞ ‡∏Ç‡∏ô‡∏°</button>
        </div>
        <!-- Products -->
        <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>

    <!-- STATUS BAR (USER) -->
    <div id="status-bar" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 p-4 hidden transform translate-y-full transition-transform duration-300 border-t border-gray-200">
        <div class="container mx-auto max-w-2xl flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div id="status-icon" class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 status-pulse"><i data-feather="clock"></i></div>
                <div>
                    <p class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <span id="status-order-id">...</span></p>
                    <p class="font-bold text-lg" id="status-text">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                </div>
            </div>
            <button onclick="clearCurrentOrder()" class="text-xs text-gray-400 underline hover:text-red-500">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- ================= VIEW: ADMIN (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô) ================= -->
    <div id="view-admin" class="container mx-auto p-4 hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</h2>
            
            <!-- Admin Tabs -->
            <div class="flex bg-gray-200 p-1 rounded-lg">
                <button onclick="switchAdminTab('kitchen')" id="tab-kitchen" class="px-4 py-2 rounded-md font-medium text-sm bg-white shadow-sm text-gray-800 transition">‡∏Ñ‡∏£‡∏±‡∏ß</button>
                <button onclick="switchAdminTab('sales')" id="tab-sales" class="px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:text-gray-800 transition">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
            </div>
            
            <button onclick="refreshAdminData()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 flex items-center gap-2 text-sm font-bold">
                <i data-feather="refresh-cw" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- TAB: KITCHEN -->
        <div id="admin-kitchen" class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-4 bg-orange-50 border-b border-orange-100 font-bold text-orange-800 flex items-center gap-2">
                <i data-feather="bell" class="w-4 h-4"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</th>
                            <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="kitchen-list" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB: SALES REPORT (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà) -->
        <div id="admin-sales" class="hidden space-y-6">
            
            <!-- Control Bar: Today's Total & Date Filter -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 1. ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
                <div class="bg-white p-5 rounded-xl shadow-md border border-green-100 flex justify-between items-center">
                    <div>
                        <h3 class="text-gray-500 text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-3xl font-bold text-green-600 mt-1" id="sales-today-total">‡∏ø0.00</p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                        <i data-feather="dollar-sign"></i>
                    </div>
                </div>

                <!-- 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 flex flex-col justify-center">
                    <label class="text-xs text-gray-500 font-medium mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="filter-date" onchange="applyDateFilter()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <!-- 3. ‡∏õ‡∏∏‡πà‡∏° Report -->
                <div class="bg-white p-5 rounded-xl shadow-md border border-blue-100 flex items-center justify-center">
                    <button onclick="openReportModal()" class="w-full h-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow transition flex items-center justify-center gap-2 py-2">
                        <i data-feather="pie-chart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Report)
                    </button>
                </div>
            </div>

            <!-- Table List -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-4 bg-blue-50 border-b border-blue-100 font-bold text-blue-800 flex items-center justify-between">
                    <div class="flex items-center gap-2"><i data-feather="file-text" class="w-4 h-4"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ & ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <span id="table-row-count" class="text-xs font-normal text-blue-600 bg-blue-100 px-2 py-1 rounded-full">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</th>
                                <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="sales-list" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-end hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl transform translate-x-full transition-transform duration-300" id="cart-panel">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button onclick="toggleCartModal(false)" class="text-gray-500"><i data-feather="x"></i></button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            <div class="p-5 border-t bg-gray-50">
                <div class="flex justify-between text-lg font-bold mb-4"><span>‡∏£‡∏ß‡∏°</span><span id="cart-total" class="text-blue-600">‡∏ø0</span></div>
                <div class="space-y-3 mb-4">
                    <input type="text" id="cust-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full border p-2 rounded">
                    <input type="text" id="table-no" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞" class="w-full border p-2 rounded">
                </div>
                <button onclick="submitOrder()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button onclick="closePaymentModal()" class="text-white hover:text-gray-200"><i data-feather="x"></i></button>
            </div>
            <div class="p-6">
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-sm">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                    <p class="text-4xl font-bold text-blue-600" id="pay-total-display">‡∏ø0.00</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="pay-received" class="w-full p-3 border rounded-lg text-xl text-center focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00" oninput="calculateChange()">
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span>
                        <span class="font-bold text-xl text-green-600" id="pay-change">‡∏ø0.00</span>
                    </div>
                </div>
                <button onclick="confirmPayment()" class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-lg flex justify-center items-center gap-2">
                    <i data-feather="check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- REPORT SUMMARY MODAL (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-xl text-gray-800"><i data-feather="pie-chart" class="inline w-5 h-5 mr-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <button onclick="closeReportModal()" class="text-gray-500 hover:text-red-500"><i data-feather="x"></i></button>
            </div>
            
            <div class="p-5 space-y-4">
                <!-- Date Range Selector -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 flex flex-col sm:flex-row gap-4 items-end">
                    <div class="w-full">
                        <label class="text-xs font-bold text-gray-500">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="report-start" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="w-full">
                        <label class="text-xs font-bold text-gray-500">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="report-end" class="w-full border rounded p-2 text-sm">
                    </div>
                    <button onclick="generateSummaryReport()" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-sm">
                        ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                    </button>
                </div>

                <!-- Result Area -->
                <div id="report-result" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded border border-green-100 text-center">
                            <p class="text-gray-600 text-sm">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                            <p class="text-2xl font-bold text-green-700" id="report-grand-total">‡∏ø0.00</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded border border-purple-100 text-center">
                            <p class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
                            <p class="text-2xl font-bold text-purple-700" id="report-order-count">0</p>
                        </div>
                    </div>

                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-4 py-2 font-bold text-sm text-gray-700">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</div>
                        <div class="max-h-60 overflow-y-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 border-b">
                                    <tr><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="p-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr>
                                </thead>
                                <tbody id="report-item-list" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // === STATE ===
        let products = [], cart = [], allSalesData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ Filter
        let currentCat = 'all';
        let pollingInterval = null;
        let activeAdminTab = 'kitchen';
        let currentPaymentOrder = null;

        // === INIT ===
        window.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            checkExistingOrder();
            // Set Default Date Filter to Today
            document.getElementById('filter-date').valueAsDate = new Date();
            // Set Report Date Range Default
            document.getElementById('report-start').valueAsDate = new Date();
            document.getElementById('report-end').valueAsDate = new Date();
            
            feather.replace();
        });

        // === DATE HELPERS (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.) ===
        function parseThaiDate(dateStr) {
            // dateStr format ex: "17/12/2568 18:41:00"
            if (!dateStr) return null;
            const parts = dateStr.split(' '); // ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
            const dateParts = parts[0].split('/'); // ‡πÅ‡∏¢‡∏Å ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
            
            if (dateParts.length !== 3) return new Date(dateStr); // Fallback

            let day = parseInt(dateParts[0]);
            let month = parseInt(dateParts[1]) - 1; // JS month 0-11
            let year = parseInt(dateParts[2]);

            // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ > 2400 ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡∏•‡∏ö 543
            if (year > 2400) year -= 543;

            return new Date(year, month, day);
        }

        function isSameDate(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        // === ADMIN: SALES & REPORT LOGIC ===

        // 1. Logic ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        function processSalesData(sales) {
            allSalesData = sales; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Global Variable
            applyDateFilter(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Filter)
        function applyDateFilter() {
            const filterInput = document.getElementById('filter-date').value;
            const filterDate = filterInput ? new Date(filterInput) : null;
            
            const tbody = document.getElementById('sales-list');
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const filteredSales = allSalesData.filter(s => {
                if (!filterDate) return true; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏°‡∏î
                const recordDate = parseThaiDate(s.time);
                return isSameDate(recordDate, filterDate);
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            renderSalesTable(filteredSales);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" (‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
            calculateTodayMetrics();
        }

        // 3. Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        function renderSalesTable(sales) {
            const tbody = document.getElementById('sales-list');
            document.getElementById('table-row-count').innerText = `${sales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if(!sales.length) return tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</td></tr>`;

            tbody.innerHTML = sales.map(s => {
                const isPaid = s.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                const statusBadge = isPaid 
                    ? `<span class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>`
                    : `<span class="px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</span>`;
                
                const actionBtn = isPaid
                    ? `<span class="text-gray-400 text-xs"><i data-feather="check"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>`
                    : `<button onclick='openPaymentModal(${JSON.stringify(s)})' class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs shadow">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>`;

                return `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4"><div class="text-xs text-gray-500">${s.time}</div><div class="font-bold">${s.tableName}</div></td>
                    <td class="p-4"><div class="text-sm font-medium">${s.buyerName}</div><div class="text-xs text-gray-500 truncate w-32">${s.items}</div></td>
                    <td class="p-4 text-right font-bold text-gray-700">‡∏ø${s.total}</td>
                    <td class="p-4 text-center">${statusBadge}</td>
                    <td class="p-4 text-center">${actionBtn}</td>
                </tr>`;
            }).join('');
            feather.replace();
        }

        // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        function calculateTodayMetrics() {
            const today = new Date();
            const todaySales = allSalesData.filter(s => {
                const d = parseThaiDate(s.time);
                return isSameDate(d, today);
            });
            const total = todaySales.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('sales-today-total').innerText = `‡∏ø${total.toLocaleString()}`;
        }

        // 5. REPORT MODAL FUNCTIONS
        function openReportModal() {
            document.getElementById('report-modal').classList.remove('hidden');
            document.getElementById('report-result').classList.add('hidden');
        }
        function closeReportModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        function generateSummaryReport() {
            const startStr = document.getElementById('report-start').value;
            const endStr = document.getElementById('report-end').value;

            if(!startStr || !endStr) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô
            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Optional: ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ)
            const reportData = allSalesData.filter(s => {
                const d = parseThaiDate(s.time);
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á)
                // return d >= startDate && d <= endDate && s.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                return d >= startDate && d <= endDate; 
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
            const grandTotal = reportData.reduce((sum, item) => sum + item.total, 0);
            
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Item Aggregation)
            const itemCounts = {};
            reportData.forEach(order => {
                // order.items format: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà (2), ‡∏ô‡πâ‡∏≥‡πÇ‡∏Ñ‡πâ‡∏Å (1)"
                const itemsArr = order.items.split(', ');
                itemsArr.forEach(itemStr => {
                    // Extract Name and Qty using Regex or Split
                    // itemStr looks like "Name (Qty)"
                    const match = itemStr.match(/(.*) \((\d+)\)/);
                    if(match) {
                        const name = match[1];
                        const qty = parseInt(match[2]);
                        if(itemCounts[name]) itemCounts[name] += qty;
                        else itemCounts[name] = qty;
                    }
                });
            });

            // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
            const sortedItems = Object.entries(itemCounts)
                .map(([name, qty]) => ({ name, qty }))
                .sort((a, b) => b.qty - a.qty); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• UI
            document.getElementById('report-grand-total').innerText = `‡∏ø${grandTotal.toLocaleString()}`;
            document.getElementById('report-order-count').innerText = `${reportData.length}`;
            
            const listHtml = sortedItems.map(i => `
                <tr class="hover:bg-gray-50 border-b last:border-0">
                    <td class="p-3 text-gray-700">${i.name}</td>
                    <td class="p-3 text-right font-bold text-gray-900">${i.qty}</td>
                </tr>
            `).join('');
            
            document.getElementById('report-item-list').innerHTML = listHtml || '<tr><td colspan="2" class="p-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            
            document.getElementById('report-result').classList.remove('hidden');
        }

        // === GENERAL FUNCTIONS (User, Cart, etc.) ===
        // ... (Functions ‡πÄ‡∏î‡∏¥‡∏°: fetchProducts, addToCart, submitOrder ‡∏Ø‡∏•‡∏Ø ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
        
        async function fetchProducts() {
            toggleLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getProducts`);
                products = await res.json();
                renderProducts();
            } catch (err) { alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); } 
            finally { toggleLoading(false); }
        }

        function renderProducts() {
            const container = document.getElementById('product-list');
            const filtered = currentCat === 'all' ? products : products.filter(p => p.category === currentCat);
            container.innerHTML = filtered.map(p => {
                const inCart = cart.find(c => c.id === p.id);
                const qty = inCart ? inCart.quantity : 0;
                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                    <div class="relative h-40">
                        <img src="${p.img}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300?text=No+Image'">
                        ${qty > 0 ? `<div class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">${qty}</div>` : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <h3 class="font-bold text-gray-800 line-clamp-1">${p.name}</h3>
                        <p class="text-blue-600 font-bold mb-3">‡∏ø${p.price}</p>
                        <button onclick="addToCart(${p.id})" class="mt-auto w-full bg-gray-50 text-blue-600 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 hover:text-white transition">‡πÄ‡∏û‡∏¥‡πà‡∏° +</button>
                    </div>
                </div>`;
            }).join('');
        }

        function filterCategory(cat) {
            currentCat = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.className = `cat-btn flex-shrink-0 px-6 py-2 rounded-full transition ${btn.dataset.cat===cat ? 'bg-blue-600 text-white shadow-md':'bg-white text-gray-600 border border-gray-200'}`);
            renderProducts();
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.quantity++; else cart.push({...p, quantity: 1});
            updateCartUI(); renderProducts();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);
            document.getElementById('cart-badge').innerText = totalItems;
            document.getElementById('cart-badge').classList.toggle('hidden', totalItems === 0);
            
            const container = document.getElementById('cart-items');
            container.innerHTML = cart.map((item, idx) => `
                <div class="flex gap-4 items-center">
                    <img src="${item.img}" class="w-12 h-12 rounded bg-gray-200 object-cover">
                    <div class="flex-1">
                        <div class="font-bold text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">‡∏ø${item.price} x ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQty(${idx}, -1)" class="w-6 h-6 bg-gray-200 rounded">-</button>
                        <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                        <button onclick="changeQty(${idx}, 1)" class="w-6 h-6 bg-gray-200 rounded">+</button>
                    </div>
                </div>`).join('');
            
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('cart-total').innerText = `‡∏ø${total}`;
        }

        function changeQty(idx, delta) {
            cart[idx].quantity += delta;
            if(cart[idx].quantity <= 0) cart.splice(idx, 1);
            updateCartUI(); renderProducts();
        }

        async function submitOrder() {
            const name = document.getElementById('cust-name').value;
            const table = document.getElementById('table-no').value;
            if(!cart.length || !name || !table) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...");
            const orderId = `ORD-${Date.now().toString().slice(-5)}`;
            const payload = {
                action: "createOrder",
                orderNumber: orderId,
                tableName: table,
                buyerName: name,
                items: cart,
                total: cart.reduce((sum, i) => sum + (i.price * i.quantity), 0)
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                localStorage.setItem('lastOrderId', orderId);
                cart = []; updateCartUI(); renderProducts(); toggleCartModal(false);
                showStatusBar(orderId); startPolling(orderId);
                alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (err) { alert("Error"); }
            finally { toggleLoading(false); }
        }

        // Polling Logic
        function checkExistingOrder() {
            const lastOrder = localStorage.getItem('lastOrderId');
            if(lastOrder) { showStatusBar(lastOrder); startPolling(lastOrder); }
        }
        function startPolling(id) {
            if(pollingInterval) clearInterval(pollingInterval);
            updateStatusUI(id);
            pollingInterval = setInterval(() => updateStatusUI(id), 5000);
        }
        async function updateStatusUI(id) {
            try {
                const res = await fetch(`${API_URL}?action=checkStatus&orderId=${id}`);
                const data = await res.json();
                const txt = document.getElementById('status-text');
                const ico = document.getElementById('status-icon');
                if(data.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') { txt.innerText="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"; ico.className="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 status-pulse"; }
                else if(data.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') { txt.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£"; txt.className="font-bold text-lg text-blue-600"; ico.className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 status-pulse"; ico.innerHTML=`<i data-feather="loader"></i>`; }
                else if(data.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') { txt.innerText="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"; txt.className="font-bold text-lg text-green-600"; ico.className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"; ico.innerHTML=`<i data-feather="check"></i>`; setTimeout(()=>clearInterval(pollingInterval),30000); }
                feather.replace();
            } catch(e){}
        }
        function showStatusBar(id) {
            const bar = document.getElementById('status-bar');
            document.getElementById('status-order-id').innerText = id;
            bar.classList.remove('hidden'); setTimeout(()=>bar.classList.remove('translate-y-full'),100);
        }
        function clearCurrentOrder() {
            localStorage.removeItem('lastOrderId'); clearInterval(pollingInterval);
            const bar = document.getElementById('status-bar');
            bar.classList.add('translate-y-full'); setTimeout(()=>bar.classList.add('hidden'),300);
        }

        // === ADMIN LOGIC ===
        function accessAdmin() {
            if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin:") === "Admin1234") {
                switchPage('admin');
                refreshAdminData();
            }
        }

        function switchPage(page) {
            document.getElementById('view-user').classList.toggle('hidden', page!=='user');
            document.getElementById('view-admin').classList.toggle('hidden', page!=='admin');
            if(page==='user') feather.replace();
        }

        function switchAdminTab(tab) {
            activeAdminTab = tab;
            const btnKitchen = document.getElementById('tab-kitchen');
            const btnSales = document.getElementById('tab-sales');
            const divKitchen = document.getElementById('admin-kitchen');
            const divSales = document.getElementById('admin-sales');

            if(tab === 'kitchen') {
                btnKitchen.className = "px-4 py-2 rounded-md font-medium text-sm bg-white shadow-sm text-gray-800 transition";
                btnSales.className = "px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:text-gray-800 transition";
                divKitchen.classList.remove('hidden');
                divSales.classList.add('hidden');
            } else {
                btnKitchen.className = "px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:text-gray-800 transition";
                btnSales.className = "px-4 py-2 rounded-md font-medium text-sm bg-white shadow-sm text-gray-800 transition";
                divKitchen.classList.add('hidden');
                divSales.classList.remove('hidden');
            }
            refreshAdminData();
        }

        async function refreshAdminData() {
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
            try {
                if(activeAdminTab === 'kitchen') {
                    const res = await fetch(`${API_URL}?action=getOrders`);
                    const orders = await res.json();
                    renderKitchenList(orders);
                } else {
                    const res = await fetch(`${API_URL}?action=getSalesReport`);
                    const sales = await res.json();
                    processSalesData(sales); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                }
            } catch(e) { console.error(e); } 
            finally { toggleLoading(false); }
        }

        function renderKitchenList(orders) {
            const tbody = document.getElementById('kitchen-list');
            if(!orders.length) return tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</td></tr>`;
            tbody.innerHTML = orders.map(o => {
                let statusColor = "bg-gray-100 text-gray-600";
                if(o.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') statusColor = "bg-blue-100 text-blue-700";
                if(o.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') statusColor = "bg-green-100 text-green-700";
                
                let buttons = '';
                if(o.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                    buttons = `<button onclick="setKitchenStatus('${o.orderNumber}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á')" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded text-xs flex items-center gap-1 shadow"><i data-feather="play-circle" class="w-4 h-4"></i> ‡∏õ‡∏£‡∏∏‡∏á</button>`;
                } else if(o.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') {
                    buttons = `<button onclick="setKitchenStatus('${o.orderNumber}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded text-xs flex items-center gap-1 shadow"><i data-feather="check-circle" class="w-4 h-4"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à</button>`;
                }
                return `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4"><div class="font-bold">${o.tableName}</div><div class="text-xs text-gray-500">${o.time.split(' ')[1]||o.time}</div></td>
                    <td class="p-4"><div class="font-medium text-sm">${o.buyerName}</div><div class="text-xs text-gray-500 mt-1">${o.items}</div></td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${o.status}</span></td>
                    <td class="p-4 flex justify-center gap-2">${buttons}</td>
                </tr>`;
            }).join('');
            feather.replace();
        }

        async function setKitchenStatus(id, status) {
            if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${status}"?`)) return;
            toggleLoading(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', orderNumber: id, newStatus: status }) });
                refreshAdminData();
            } catch(e) { alert("Error"); }
            finally { toggleLoading(false); }
        }

        // --- Payment Logic ---
        function openPaymentModal(order) {
            currentPaymentOrder = order;
            document.getElementById('pay-total-display').innerText = `‡∏ø${order.total}`;
            document.getElementById('pay-received').value = '';
            document.getElementById('pay-change').innerText = '‡∏ø0.00';
            document.getElementById('payment-modal').classList.remove('hidden');
            document.getElementById('pay-received').focus();
        }
        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            currentPaymentOrder = null;
        }
        function calculateChange() {
            if(!currentPaymentOrder) return;
            const received = parseFloat(document.getElementById('pay-received').value) || 0;
            const change = received - currentPaymentOrder.total;
            const changeEl = document.getElementById('pay-change');
            if(change >= 0) { changeEl.innerText = `‡∏ø${change.toFixed(2)}`; changeEl.className = "font-bold text-xl text-green-600"; } 
            else { changeEl.innerText = `‡∏Ç‡∏≤‡∏î ‡∏ø${Math.abs(change).toFixed(2)}`; changeEl.className = "font-bold text-xl text-red-600"; }
        }
        async function confirmPayment() {
            if(!currentPaymentOrder) return;
            const received = parseFloat(document.getElementById('pay-received').value) || 0;
            if(received < currentPaymentOrder.total) { alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô?")) return;
            toggleLoading(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updatePayment', orderNumber: currentPaymentOrder.orderNumber }) });
                closePaymentModal();
                refreshAdminData(); // Refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
            } catch(e) { alert("Error"); }
            finally { toggleLoading(false); }
        }

        // Utils
        function toggleCartModal(show) {
            const el=document.getElementById('cart-modal'), pn=document.getElementById('cart-panel');
            if(show){el.classList.remove('hidden');setTimeout(()=>{el.classList.remove('opacity-0');pn.classList.remove('translate-x-full')},10)}
            else{el.classList.add('opacity-0');pn.classList.add('translate-x-full');setTimeout(()=>el.classList.add('hidden'),300)}
        }
        function toggleLoading(show, txt="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."){
            document.getElementById('loading-overlay').classList.toggle('hidden',!show);
            document.getElementById('loading-text').innerText=txt;
        }
    </script>
</body>
</html>
