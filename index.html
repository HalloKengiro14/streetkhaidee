<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสั่งอาหารออนไลน์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Sarabun', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        /* Loading Overlay */
        #loading-overlay { display: none; }
        #loading-overlay.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 pb-20">

    <!-- Config script -->
    <script>
        // ==========================================
        //  นำ Web App URL จาก Google Apps Script มาวางตรงนี้
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbweuotqV6OkcZDlB67l6zchQEmjTRPRhHYxZ2V6S0FwZKmySHeDHMG5ZQ6_PoUHG2pWYg/exec"; 
    </script>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] justify-center items-center flex-col">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <p class="text-white text-lg font-semibold" id="loading-text">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-blue-700">FOOD APP</span>
                </div>
                <!-- Cart Icon -->
                <button id="cart-icon" class="relative p-2 rounded-full text-gray-600 hover:bg-gray-100">
                    <i data-feather="shopping-cart"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app-root" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Content Rendered by JS -->
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold"><i data-feather="shopping-cart" class="inline mr-2"></i> ตะกร้าสินค้า</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600"><i data-feather="x"></i></button>
            </div>
            <div id="cart-items" class="p-6 space-y-4 overflow-y-auto modal-content flex-grow"></div>
            <div class="p-6 border-t bg-gray-50 rounded-b-xl">
                <div class="flex justify-between mb-4">
                    <span class="text-lg font-medium">รวมทั้งหมด:</span>
                    <span id="cart-total" class="text-2xl font-bold text-blue-700">฿0.00</span>
                </div>
                <button id="confirm-cart" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">ยืนยันรายการ</button>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        const state = {
            products: [],
            cart: [],
            currentPage: 'home',
            currentOrder: null
        };

        const appRoot = document.getElementById('app-root');
        const cartModal = document.getElementById('cart-modal');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // --- Loading Helper ---
        function toggleLoading(show, text = "กำลังโหลด...") {
            loadingText.textContent = text;
            if(show) loadingOverlay.classList.add('active');
            else loadingOverlay.classList.remove('active');
        }

        // --- Fetch Data ---
        async function fetchProducts() {
            if(API_URL === "วาง_WEB_APP_URL_ที่ได้จากขั้นตอนที่2_ที่นี่" || API_URL === "") {
                alert("กรุณาใส่ Web App URL ในโค้ดก่อนใช้งาน");
                return;
            }

            toggleLoading(true, "กำลังดึงเมนูอาหาร...");
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                state.products = data;
                renderHomePage();
            } catch (error) {
                console.error("Error fetching products:", error);
                appRoot.innerHTML = `<div class="text-center text-red-500 mt-10">ไม่สามารถโหลดข้อมูลได้ <br> <button onclick="location.reload()" class="mt-4 underline">ลองใหม่อีกครั้ง</button></div>`;
            } finally {
                toggleLoading(false);
            }
        }

        async function sendOrderToSheet(orderData) {
            toggleLoading(true, "กำลังบันทึกออเดอร์...");
            
            // ใช้ fetch POST แบบ no-cors หรือ text/plain เพื่อเลี่ยงปัญหา CORS เบื้องต้นของ Apps Script
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
                
                // Google Apps Script text output needs handling
                const result = await response.json(); 
                
                if(result.status === 'success') {
                    // Clear Cart
                    state.cart = [];
                    updateCartBadge();
                    renderConfirmationPage(orderData);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert("เกิดข้อผิดพลาดในการสั่งซื้อ: " + error.message);
                console.error(error);
            } finally {
                toggleLoading(false);
            }
        }

        // --- Rendering ---
        function renderHomePage() {
            state.currentPage = 'home';
            appRoot.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${state.products.map(product => {
                        const inCart = state.cart.find(c => c.id == product.id);
                        const qty = inCart ? inCart.quantity : 1;
                        return `
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col h-full">
                            <img src="${product.img}" class="w-full h-48 object-cover bg-gray-200" alt="${product.name}" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                            <div class="p-5 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold mb-1">${product.name}</h3>
                                <p class="text-xl font-bold text-blue-600 mb-4">฿${product.price}</p>
                                <div class="mt-auto flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <button class="bg-gray-200 w-8 h-8 rounded text-xl font-bold" onclick="adjustQty(${product.id}, -1)">-</button>
                                        <input id="qty-${product.id}" type="number" value="${qty}" class="w-10 text-center border rounded p-1" readonly>
                                        <button class="bg-gray-200 w-8 h-8 rounded text-xl font-bold" onclick="adjustQty(${product.id}, 1)">+</button>
                                    </div>
                                    <button onclick="addToCart(${product.id})" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                                        <i data-feather="shopping-cart" class="w-4 h-4 inline"></i> เพิ่ม
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
            feather.replace();
        }

        function renderCheckoutPage() {
            toggleCartModal(false);
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            appRoot.innerHTML = `
                <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg">
                    <button onclick="renderHomePage()" class="mb-4 text-gray-500 hover:text-gray-800"><i data-feather="arrow-left" class="inline"></i> กลับไปเลือกเมนู</button>
                    <h2 class="text-2xl font-bold mb-6">สรุปรายการสั่งซื้อ</h2>
                    <div class="space-y-2 mb-4 border-b pb-4">
                        ${state.cart.map(item => `
                            <div class="flex justify-between">
                                <span>${item.name} x${item.quantity}</span>
                                <span>฿${(item.price * item.quantity).toFixed(2)}</span>
                            </div>`).join('')}
                    </div>
                    <div class="flex justify-between text-xl font-bold mb-6">
                        <span>ยอดสุทธิ</span>
                        <span class="text-blue-700">฿${total.toFixed(2)}</span>
                    </div>
                    
                    <form id="order-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium">ชื่อลูกค้า</label>
                            <input type="text" id="cust-name" required class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">เบอร์โต๊ะ / จุดส่ง</label>
                            <input type="text" id="table-no" required class="w-full border p-2 rounded" placeholder="เช่น โต๊ะ 5">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700">
                            ยืนยันการสั่งซื้อ
                        </button>
                    </form>
                </div>`;
            feather.replace();

            document.getElementById('order-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('cust-name').value;
                const table = document.getElementById('table-no').value;
                
                const orderData = {
                    orderNumber: `ORD-${Date.now()}`,
                    tableName: table,
                    buyerName: name,
                    items: state.cart,
                    total: total
                };
                sendOrderToSheet(orderData);
            });
        }

        function renderConfirmationPage(order) {
            appRoot.innerHTML = `
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg text-center mt-10">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-feather="check" class="w-10 h-10 text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">สั่งอาหารเรียบร้อย!</h2>
                    <p class="text-gray-600 mb-6">เราได้รับรายการของคุณแล้ว</p>
                    <div class="bg-gray-50 p-4 rounded mb-6 text-left">
                        <p><strong>หมายเลข:</strong> ${order.orderNumber}</p>
                        <p><strong>คุณ:</strong> ${order.buyerName}</p>
                        <p><strong>โต๊ะ:</strong> ${order.tableName}</p>
                    </div>
                    <button onclick="renderHomePage()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">สั่งเพิ่ม / กลับหน้าหลัก</button>
                </div>`;
            feather.replace();
        }

        // --- Logic Functions ---
        function addToCart(id) {
            const product = state.products.find(p => p.id == id);
            const qtyInput = document.getElementById(`qty-${id}`);
            const qty = parseInt(qtyInput.value);
            
            const existing = state.cart.find(item => item.id == id);
            if (existing) {
                existing.quantity += qty; // Add to existing
            } else {
                state.cart.push({ ...product, quantity: qty });
            }
            
            qtyInput.value = 1; // Reset input
            updateCartBadge();
            // Optional: Alert or Toast
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-feather="check" class="inline w-4"></i> เพิ่มแล้ว`;
            btn.classList.add('bg-green-600');
            feather.replace();
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-green-600');
                feather.replace();
            }, 1000);
        }

        function adjustQty(id, delta) {
            const input = document.getElementById(`qty-${id}`);
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            input.value = val;
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            updateCartBadge();
            renderCartItems();
        }

        function updateCartBadge() {
            const count = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            if(state.cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ตะกร้าว่างเปล่า</p>';
                document.getElementById('cart-total').innerText = '฿0.00';
                document.getElementById('confirm-cart').disabled = true;
                document.getElementById('confirm-cart').classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            document.getElementById('confirm-cart').disabled = false;
            document.getElementById('confirm-cart').classList.remove('opacity-50', 'cursor-not-allowed');

            container.innerHTML = state.cart.map((item, index) => `
                <div class="flex justify-between items-center border-b pb-2">
                    <div>
                        <div class="font-bold">${item.name}</div>
                        <div class="text-sm text-gray-500">฿${item.price} x ${item.quantity}</div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold mr-4">฿${item.price * item.quantity}</span>
                        <button onclick="removeFromCart(${index})" class="text-red-500"><i data-feather="trash-2" class="w-4"></i></button>
                    </div>
                </div>
            `).join('');
            
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cart-total').innerText = '฿' + total.toFixed(2);
            feather.replace();
        }

        function toggleCartModal(show) {
            const modal = document.getElementById('cart-modal');
            if (show) {
                renderCartItems();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        document.getElementById('cart-icon').addEventListener('click', () => toggleCartModal(true));
        document.querySelector('.close-modal').addEventListener('click', () => toggleCartModal(false));
        document.getElementById('confirm-cart').addEventListener('click', renderCheckoutPage);

        // --- Init ---
        fetchProducts(); // Start app
    </script>
</body>
</html>

