<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        /* Animation for status */
        .status-badge { transition: all 0.3s; }
    </style>
</head>
<body class="bg-gray-50 pb-20">

    <!-- CONFIG -->
    <script>
        // ==========================================
        //  ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbweuotqV6OkcZDlB67l6zchQEmjTRPRhHYxZ2V6S0FwZKmySHeDHMG5ZQ6_PoUHG2pWYg/exec"; 
    </script>

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex flex-col justify-center items-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-white mb-3"></div>
        <p class="text-white font-medium" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- HEADER -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600 tracking-tighter cursor-pointer" onclick="toggleView('user')">FOOD APP</div>
            
            <div class="flex items-center gap-3">
                <!-- ‡∏õ‡∏∏‡πà‡∏° Admin -->
                <button onclick="accessAdmin()" class="text-gray-500 hover:text-blue-600 text-sm font-medium">
                    <i data-feather="monitor" class="w-5 h-5"></i>
                </button>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
                <button onclick="toggleCartModal(true)" class="relative p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                    <i data-feather="shopping-cart" class="w-5 h-5 text-gray-700"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- VIEW: USER (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) -->
    <div id="view-user" class="container mx-auto p-4 transition-opacity duration-300">
        
        <!-- Category Tabs -->
        <div class="flex overflow-x-auto gap-3 mb-6 hide-scroll pb-2">
            <button onclick="filterCategory('all')" class="cat-btn active flex-shrink-0 px-6 py-2 rounded-full bg-blue-600 text-white font-medium shadow-md transition" data-cat="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="filterCategory('food')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 font-medium hover:bg-gray-50 transition" data-cat="food">üç≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
            <button onclick="filterCategory('drink')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 font-medium hover:bg-gray-50 transition" data-cat="drink">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
            <button onclick="filterCategory('dessert')" class="cat-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-gray-600 border border-gray-200 font-medium hover:bg-gray-50 transition" data-cat="dessert">üç∞ ‡∏Ç‡∏ô‡∏°</button>
        </div>

        <!-- Product Grid -->
        <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Products will be injected here -->
        </div>
    </div>

    <!-- VIEW: ADMIN (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤) -->
    <div id="view-admin" class="container mx-auto p-4 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
            <button onclick="fetchOrders()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 flex items-center gap-2">
                <i data-feather="refresh-cw" class="w-4 h-4"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
        </div>

        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</th>
                            <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="p-4">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                            <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="admin-order-list" class="divide-y divide-gray-100 text-sm">
                        <!-- Order rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-end hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl transform translate-x-full transition-transform duration-300" id="cart-panel">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button onclick="toggleCartModal(false)" class="text-gray-500 hover:text-gray-800"><i data-feather="x"></i></button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            <div class="p-5 border-t bg-gray-50">
                <div class="flex justify-between text-lg font-bold mb-4">
                    <span>‡∏£‡∏ß‡∏°</span>
                    <span id="cart-total" class="text-blue-600">‡∏ø0</span>
                </div>
                <!-- Form -->
                <div class="space-y-3 mb-4">
                    <input type="text" id="cust-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="text" id="table-no" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞ / ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="submitOrder()" id="btn-submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg disabled:bg-gray-400">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
        </div>
    </div>

    <script>
        // === STATE & INIT ===
        let products = [];
        let cart = [];
        let currentCat = 'all';

        feather.replace();

        // Start
        window.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
        });

        // === USER FUNCTIONS ===

        async function fetchProducts() {
            toggleLoading(true);
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action=getProducts
                const res = await fetch(`${API_URL}?action=getProducts`);
                const data = await res.json();
                products = data;
                renderProducts();
            } catch (err) {
                alert("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err);
            } finally {
                toggleLoading(false);
            }
        }

        function renderProducts() {
            const container = document.getElementById('product-list');
            const filtered = currentCat === 'all' ? products : products.filter(p => p.category === currentCat);

            container.innerHTML = filtered.map(p => {
                const inCart = cart.find(c => c.id === p.id);
                const qty = inCart ? inCart.quantity : 0;
                
                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col hover:shadow-md transition">
                    <div class="relative h-40">
                        <img src="${p.img}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300x200?text=No+Image'">
                        ${qty > 0 ? `<div class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow">${qty}</div>` : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800 line-clamp-1">${p.name}</h3>
                        </div>
                        <p class="text-blue-600 font-bold mb-4">‡∏ø${p.price}</p>
                        <button onclick="addToCart(${p.id})" class="mt-auto w-full bg-gray-100 text-blue-600 py-2 rounded-lg font-medium hover:bg-blue-600 hover:text-white transition flex justify-center items-center gap-2">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function filterCategory(cat) {
            currentCat = cat;
            // Update buttons
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.dataset.cat === cat) {
                    btn.classList.remove('bg-white', 'text-gray-600', 'border');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                } else {
                    btn.classList.add('bg-white', 'text-gray-600', 'border');
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                }
            });
            renderProducts();
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.quantity++;
            else cart.push({...p, quantity: 1});
            
            updateCartUI();
            renderProducts(); // Update qty badge on card
        }

        function updateCartUI() {
            const badge = document.getElementById('cart-badge');
            const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);
            badge.innerText = totalItems;
            badge.classList.toggle('hidden', totalItems === 0);

            const container = document.getElementById('cart-items');
            if(cart.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><i data-feather="shopping-bag" class="mx-auto w-12 h-12 mb-2"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p></div>`;
                feather.replace();
            } else {
                container.innerHTML = cart.map((item, idx) => `
                    <div class="flex gap-4 mb-4 items-center">
                        <img src="${item.img}" class="w-16 h-16 rounded object-cover bg-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm">${item.name}</h4>
                            <div class="text-xs text-gray-500">‡∏ø${item.price}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changeQty(${idx}, -1)" class="w-6 h-6 bg-gray-200 rounded text-gray-600">-</button>
                            <span class="text-sm w-4 text-center">${item.quantity}</span>
                            <button onclick="changeQty(${idx}, 1)" class="w-6 h-6 bg-gray-200 rounded text-gray-600">+</button>
                        </div>
                    </div>
                `).join('');
            }

            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('cart-total').innerText = `‡∏ø${total}`;
        }

        function changeQty(index, delta) {
            cart[index].quantity += delta;
            if(cart[index].quantity <= 0) cart.splice(index, 1);
            updateCartUI();
            renderProducts();
        }

        async function submitOrder() {
            const name = document.getElementById('cust-name').value;
            const table = document.getElementById('table-no').value;

            if(!cart.length || !name || !table) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
                return;
            }

            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...");
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            
            const payload = {
                action: "createOrder", // ‡∏ö‡∏≠‡∏Å Backend ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á
                orderNumber: `ORD-${Date.now().toString().slice(-6)}`,
                tableName: table,
                buyerName: name,
                items: cart,
                total: total
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                cart = [];
                updateCartUI();
                renderProducts();
                document.getElementById('cust-name').value = '';
                document.getElementById('table-no').value = '';
                toggleCartModal(false);
                alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
            } finally {
                toggleLoading(false);
            }
        }

        // === ADMIN FUNCTIONS ===

        function accessAdmin() {
            const pass = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:");
            if(pass === "Admin1234") {
                toggleView('admin');
                fetchOrders();
            } else if(pass) {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
        }

        async function fetchOrders() {
            toggleLoading(true, "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...");
            try {
                const res = await fetch(`${API_URL}?action=getOrders`);
                const orders = await res.json();
                renderAdminOrders(orders);
            } catch (err) {
                console.error(err);
            } finally {
                toggleLoading(false);
            }
        }

        function renderAdminOrders(orders) {
            const tbody = document.getElementById('admin-order-list');
            if(!orders.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
                return;
            }

            tbody.innerHTML = orders.map(o => {
                let statusClass = "bg-gray-100 text-gray-600";
                if(o.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') statusClass = "bg-yellow-100 text-yellow-700";
                if(o.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') statusClass = "bg-blue-100 text-blue-700";
                if(o.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') statusClass = "bg-green-100 text-green-700";

                return `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${o.tableName}</div>
                        <div class="text-xs text-gray-500">${o.time.split(' ')[1] || o.time}</div>
                    </td>
                    <td class="p-4">
                        <div class="text-sm font-medium">${o.buyerName}</div>
                        <div class="text-xs text-gray-500 mt-1">${o.items}</div>
                    </td>
                    <td class="p-4 font-bold text-gray-700">‡∏ø${o.total}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${o.status}</span></td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-2">
                            ${o.status !== '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á' && o.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 
                                `<button onclick="updateStatus('${o.orderNumber}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á')" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-xs" title="‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå/‡∏õ‡∏£‡∏∏‡∏á"><i data-feather="loader" class="w-4 h-4"></i></button>` : ''}
                            
                            ${o.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 
                                `<button onclick="updateStatus('${o.orderNumber}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 text-xs" title="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"><i data-feather="check" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            feather.replace();
        }

        async function updateStatus(orderId, newStatus) {
            if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${newStatus}"?`)) return;
            
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...");
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateStatus',
                        orderNumber: orderId,
                        newStatus: newStatus
                    })
                });
                await fetchOrders(); // Reload table
            } catch (err) {
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } finally {
                toggleLoading(false);
            }
        }

        // === UTILS ===
        function toggleView(view) {
            document.getElementById('view-user').classList.toggle('hidden', view !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
        }

        function toggleCartModal(show) {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            if(show) {
                modal.classList.remove('hidden');
                // Small delay for animation
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    panel.classList.remove('translate-x-full');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                panel.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function toggleLoading(show, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
            const el = document.getElementById('loading-overlay');
            document.getElementById('loading-text').innerText = text;
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

    </script>
</body>
</html>
